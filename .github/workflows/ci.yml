name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

env:
  CLANG_FORMAT_VER: 20

jobs:
  linux:
    name: Linux (${{ matrix.compiler }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - compiler: gcc
            preset: ci-linux-gcc
            cc: gcc-13
            cxx: g++-13
          - compiler: clang
            preset: ci-linux-clang
            cc: clang-18
            cxx: clang++-18

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install compiler
        run: |
          sudo apt-get update
          if [[ "${{ matrix.compiler }}" == "gcc" ]]; then
            sudo apt-get install -y ${{ matrix.cc }} ${{ matrix.cxx }} ninja-build
          else
            sudo apt-get install -y clang-18 ninja-build
          fi

      - name: Configure
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: cmake --preset ${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Test
        run: ctest --preset ${{ matrix.preset }}

  windows:
    name: Windows (MSVC)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Ninja
        run: choco install ninja -y

      - name: Configure
        run: cmake --preset ci-windows-msvc

      - name: Build
        run: cmake --build --preset ci-windows-msvc

      - name: Test
        run: ctest --preset ci-windows-msvc

  macos:
    name: macOS
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Ninja
        run: brew install ninja

      - name: Configure
        run: cmake --preset ci-macos

      - name: Build
        run: cmake --build --preset ci-macos

      - name: Test
        run: ctest --preset ci-macos

  arm-gcc:
    name: ARM GCC (Embedded)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Install ARM GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi ninja-build
      
      - name: Configure
        run: cmake --preset arm-gcc
      
      - name: Build
        run: cmake --build --preset arm-gcc 2>&1 || echo "Header-only library check complete"
      
      - name: Verify headers compile
        run: |
          echo '#include "tmcxx/tmc5160.hpp"' > /tmp/test.cpp
          echo 'int main() { return 0; }' >> /tmp/test.cpp
          arm-none-eabi-g++ -std=c++20 -I${{ github.workspace }}/include \
            -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp-d16 \
            -fno-exceptions -fno-rtti -fsyntax-only /tmp/test.cpp

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-${CLANG_FORMAT_VER} cppcheck

      - name: Check formatting
        run: |
          find include -name "*.hpp" -o -name "*.cpp" | \
            grep -v "/vendor/" | \
            xargs clang-format-${CLANG_FORMAT_VER} --dry-run --Werror

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,performance,portability \
            --suppress=missingIncludeSystem \
            --error-exitcode=0 \
            --inline-suppr \
            -I include \
            include/ tests/
        continue-on-error: true

  ci-success:
    name: CI Success
    needs: [linux, windows, macos]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.linux.result }}" == "success" && \
                "${{ needs.windows.result }}" == "success" && \
                "${{ needs.macos.result }}" == "success" ]]; then
            echo "All CI jobs passed!"
            exit 0
          else
            echo "Some CI jobs failed"
            echo "Linux: ${{ needs.linux.result }}"
            echo "Windows: ${{ needs.windows.result }}"
            echo "macOS: ${{ needs.macos.result }}"
            exit 1
          fi
